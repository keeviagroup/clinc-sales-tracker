<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Sales Reporting System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            max-width: 1200px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: #0066CC;
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 15px;
            font-weight: 400;
        }

        .content {
            padding: 40px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #1d1d1f;
            font-weight: 500;
            font-size: 15px;
            letter-spacing: -0.2px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0066CC;
            box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
        }

        .btn {
            background: #0066CC;
            color: white;
            padding: 13px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
            letter-spacing: -0.2px;
        }

        .btn:hover {
            background: #0052A3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: #dc3545;
        }

        .user-info {
            background: #f5f5f7;
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info strong {
            color: #0066CC;
            font-weight: 500;
        }

        .sales-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .sales-card {
            background: #f5f5f7;
            padding: 24px;
            border-radius: 12px;
            border-left: 3px solid #0066CC;
        }

        .sales-card h3 {
            color: #1d1d1f;
            margin-bottom: 12px;
            font-size: 15px;
            font-weight: 500;
        }

        .sales-card .amount {
            font-size: 32px;
            font-weight: 600;
            color: #0066CC;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .sales-card .date {
            color: #86868b;
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid #d2d2d7;
        }

        th {
            background: #f5f5f7;
            font-weight: 500;
            color: #1d1d1f;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #fafafa;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 1px solid #d2d2d7;
            padding: 0 40px;
        }

        .nav-tab {
            padding: 14px 20px;
            background: none;
            border: none;
            color: #86868b;
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            letter-spacing: -0.2px;
        }

        .nav-tab.active {
            color: #0066CC;
            border-bottom-color: #0066CC;
        }

        .nav-tab:hover {
            color: #1d1d1f;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: #0066CC;
            color: white;
            padding: 28px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box .label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 12px;
            font-weight: 400;
        }

        .stat-box .value {
            font-size: 36px;
            font-weight: 600;
            letter-spacing: -1px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Clinic Sales Reporting System</h1>
            <p>Track daily sales across all clinic locations</p>
        </div>

        <div class="content">
            <!-- LOGIN SCREEN -->
            <div id="loginScreen" class="screen active">
                <h2 style="margin-bottom: 30px; color: #333;">Login to Continue</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" required placeholder="your.email@clinic.com">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn">Login</button>
                    <button type="button" class="btn btn-secondary" onclick="showScreen('signupScreen')">Create New Account</button>
                </form>
            </div>

            <!-- SIGNUP SCREEN -->
            <div id="signupScreen" class="screen">
                <h2 style="margin-bottom: 30px; color: #333;">Create Account</h2>
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" required placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="signupClinic">Clinic Location</label>
                        <select id="signupClinic" required>
                            <option value="">Select Clinic</option>
                            <option value="Downtown Clinic">Downtown Clinic</option>
                            <option value="Westside Clinic">Westside Clinic</option>
                            <option value="Northgate Clinic">Northgate Clinic</option>
                            <option value="Eastside Clinic">Eastside Clinic</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" required placeholder="your.email@clinic.com">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required placeholder="Create a password (min 6 characters)">
                    </div>
                    <button type="submit" class="btn">Create Account</button>
                    <button type="button" class="btn btn-secondary" onclick="showScreen('loginScreen')">Back to Login</button>
                </form>
            </div>

            <!-- DASHBOARD SCREEN -->
            <div id="dashboardScreen" class="screen">
                <div class="user-info">
                    <div>
                        <strong id="userName"></strong> | <span id="userClinic"></span>
                    </div>
                    <button class="btn btn-danger" onclick="logout()" style="width: auto; padding: 10px 20px;">Logout</button>
                </div>

                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab('entry')">Enter Sales</button>
                    <button class="nav-tab" onclick="switchTab('view')">View Reports</button>
                    <button class="nav-tab" onclick="switchTab('analytics')">Analytics</button>
                </div>

                <!-- ENTRY TAB -->
                <div id="entryTab" class="tab-content active">
                    <h2 style="margin-bottom: 20px; color: #333;">Daily Sales Entry</h2>
                    <form id="salesForm">
                        <div class="form-group">
                            <label for="salesDate">Date</label>
                            <input type="date" id="salesDate" required>
                        </div>
                        <div class="form-group">
                            <label for="totalSales">Total Sales Amount ($)</label>
                            <input type="number" id="totalSales" step="0.01" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="patientCount">Number of Patients</label>
                            <input type="number" id="patientCount" required placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="salesNotes">Notes (Optional)</label>
                            <textarea id="salesNotes" rows="3" placeholder="Any special notes about today's sales..."></textarea>
                        </div>
                        <button type="submit" class="btn">Submit Sales Report</button>
                    </form>
                </div>

                <!-- VIEW TAB -->
                <div id="viewTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #1d1d1f; font-weight: 600; font-size: 28px; letter-spacing: -0.5px;">Sales Reports</h2>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="exportToExcel()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <span>ðŸ“Š</span> Export to Excel
                            </button>
                            <button onclick="exportToPDF()" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <span>ðŸ“„</span> Export to PDF
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="form-group">
                            <label for="filterClinic">Filter by Clinic</label>
                            <select id="filterClinic" onchange="loadReports()">
                                <option value="all">All Clinics</option>
                                <option value="Downtown Clinic">Downtown Clinic</option>
                                <option value="Westside Clinic">Westside Clinic</option>
                                <option value="Northgate Clinic">Northgate Clinic</option>
                                <option value="Eastside Clinic">Eastside Clinic</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="filterDateRange">Filter by Date Range</label>
                            <select id="filterDateRange" onchange="handleDateRangeChange()">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="thisWeek">This Week</option>
                                <option value="lastWeek">Last Week</option>
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="thisQuarter">This Quarter</option>
                                <option value="lastQuarter">Last Quarter</option>
                                <option value="ytd">Year to Date</option>
                                <option value="lastYear">Last Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>

                    <div id="customDateRange" style="display: none; margin-bottom: 30px; padding: 20px; background: #f5f5f7; border-radius: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="customStartDate">Start Date</label>
                                <input type="date" id="customStartDate">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="customEndDate">End Date</label>
                                <input type="date" id="customEndDate">
                            </div>
                            <button onclick="applyCustomDateRange()" style="background: #0066CC; color: white; padding: 13px 24px; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer;">Apply</button>
                        </div>
                    </div>

                    <div id="reportsSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <!-- Summary stats will be inserted here -->
                    </div>

                    <div id="reportsContainer">
                        <p style="color: #86868b;">Loading reports...</p>
                    </div>
                </div>

                <!-- ANALYTICS TAB -->
                <div id="analyticsTab" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: #1d1d1f; font-weight: 600; font-size: 28px; letter-spacing: -0.5px;">Sales Analytics</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="form-group">
                            <label for="analyticsDateRange">Date Range</label>
                            <select id="analyticsDateRange" onchange="loadAnalytics()">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="thisWeek">This Week</option>
                                <option value="lastWeek">Last Week</option>
                                <option value="thisMonth">This Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="thisQuarter">This Quarter</option>
                                <option value="lastQuarter">Last Quarter</option>
                                <option value="ytd">Year to Date</option>
                                <option value="lastYear">Last Year</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="stats-row" id="statsContainer">
                        <div class="stat-box">
                            <div class="label">Total Sales</div>
                            <div class="value" id="totalSalesAll">$0</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Total Patients</div>
                            <div class="value" id="totalPatients">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Average per Patient</div>
                            <div class="value" id="avgPerPatient">$0</div>
                        </div>
                    </div>

                    <div class="sales-grid" id="clinicBreakdown"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://freytbzqdckqjlllcitd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyZXl0YnpxZGNrcWpsbGxjaXRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTAwNjMsImV4cCI6MjA3OTUyNjA2M30.fKx2ccRzp9TBsaqQbDDAmiU1lPfU7oqjgL9Una_DK_U';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentReportsData = []; // Store current reports for export

        // ============================================
        // AUTHENTICATION
        // ============================================
        
        // Check if user is already logged in
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                showScreen('dashboardScreen');
            }
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                alert('Login failed: ' + error.message);
            } else {
                currentUser = data.user;
                await loadUserProfile();
                showScreen('dashboardScreen');
            }
        });

        // Signup form handler
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const clinic = document.getElementById('signupClinic').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password
            });

            if (error) {
                alert('Signup failed: ' + error.message);
            } else {
                // Create user profile
                const { error: profileError } = await supabase
                    .from('user_profiles')
                    .insert([
                        { 
                            user_id: data.user.id,
                            name: name,
                            clinic: clinic,
                            email: email
                        }
                    ]);

                if (profileError) {
                    alert('Profile creation failed: ' + profileError.message);
                } else {
                    alert('Account created successfully! Please login.');
                    showScreen('loginScreen');
                }
            }
        });

        async function loadUserProfile() {
            const { data, error } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('user_id', currentUser.id)
                .single();

            if (data) {
                document.getElementById('userName').textContent = data.name;
                document.getElementById('userClinic').textContent = data.clinic;
                currentUser.profile = data;
                
                // Set today's date as default
                document.getElementById('salesDate').valueAsDate = new Date();
                
                // Load initial data
                loadReports();
                loadAnalytics();
            }
        }

        function logout() {
            supabase.auth.signOut();
            currentUser = null;
            showScreen('loginScreen');
        }

        // ============================================
        // SALES ENTRY
        // ============================================
        
        document.getElementById('salesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const salesData = {
                user_id: currentUser.id,
                clinic: currentUser.profile.clinic,
                date: document.getElementById('salesDate').value,
                total_sales: parseFloat(document.getElementById('totalSales').value),
                patient_count: parseInt(document.getElementById('patientCount').value),
                notes: document.getElementById('salesNotes').value
            };

            const { data, error } = await supabase
                .from('sales_reports')
                .insert([salesData]);

            if (error) {
                alert('Error submitting sales: ' + error.message);
            } else {
                alert('Sales report submitted successfully!');
                document.getElementById('salesForm').reset();
                document.getElementById('salesDate').valueAsDate = new Date();
                loadReports();
                loadAnalytics();
            }
        });

        // ============================================
        // DATE RANGE UTILITIES
        // ============================================
        
        function getDateRange(rangeType) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let startDate, endDate;

            switch(rangeType) {
                case 'today':
                    startDate = today;
                    endDate = today;
                    break;
                
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate = yesterday;
                    endDate = yesterday;
                    break;
                
                case 'thisWeek':
                    const dayOfWeek = today.getDay();
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - dayOfWeek);
                    startDate = startOfWeek;
                    endDate = today;
                    break;
                
                case 'lastWeek':
                    const lastWeekEnd = new Date(today);
                    lastWeekEnd.setDate(today.getDate() - today.getDay() - 1);
                    const lastWeekStart = new Date(lastWeekEnd);
                    lastWeekStart.setDate(lastWeekEnd.getDate() - 6);
                    startDate = lastWeekStart;
                    endDate = lastWeekEnd;
                    break;
                
                case 'thisMonth':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = today;
                    break;
                
                case 'lastMonth':
                    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                    startDate = lastMonthStart;
                    endDate = lastMonthEnd;
                    break;
                
                case 'thisQuarter':
                    const currentQuarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), currentQuarter * 3, 1);
                    endDate = today;
                    break;
                
                case 'lastQuarter':
                    const lastQuarter = Math.floor(now.getMonth() / 3) - 1;
                    const quarterYear = lastQuarter < 0 ? now.getFullYear() - 1 : now.getFullYear();
                    const adjustedQuarter = lastQuarter < 0 ? 3 : lastQuarter;
                    startDate = new Date(quarterYear, adjustedQuarter * 3, 1);
                    endDate = new Date(quarterYear, adjustedQuarter * 3 + 3, 0);
                    break;
                
                case 'ytd':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = today;
                    break;
                
                case 'lastYear':
                    startDate = new Date(now.getFullYear() - 1, 0, 1);
                    endDate = new Date(now.getFullYear() - 1, 11, 31);
                    break;
                
                case 'all':
                default:
                    return null;
            }

            return {
                start: startDate.toISOString().split('T')[0],
                end: endDate.toISOString().split('T')[0]
            };
        }

        function handleDateRangeChange() {
            const rangeType = document.getElementById('filterDateRange').value;
            const customRangeDiv = document.getElementById('customDateRange');
            
            if (rangeType === 'custom') {
                customRangeDiv.style.display = 'block';
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                document.getElementById('customStartDate').value = lastMonth.toISOString().split('T')[0];
                document.getElementById('customEndDate').value = today;
            } else {
                customRangeDiv.style.display = 'none';
                loadReports();
            }
        }

        function applyCustomDateRange() {
            loadReports();
        }

        // ============================================
        // VIEW REPORTS
        // ============================================
        
        async function loadReports() {
            const filterClinic = document.getElementById('filterClinic').value;
            const rangeType = document.getElementById('filterDateRange').value;
            
            let query = supabase
                .from('sales_reports')
                .select('*')
                .order('date', { ascending: false });

            if (filterClinic !== 'all') {
                query = query.eq('clinic', filterClinic);
            }

            // Apply date filtering
            if (rangeType === 'custom') {
                const startDate = document.getElementById('customStartDate').value;
                const endDate = document.getElementById('customEndDate').value;
                if (startDate && endDate) {
                    query = query.gte('date', startDate).lte('date', endDate);
                }
            } else if (rangeType !== 'all') {
                const dateRange = getDateRange(rangeType);
                if (dateRange) {
                    query = query.gte('date', dateRange.start).lte('date', dateRange.end);
                }
            }

            const { data, error } = await query;

            if (error) {
                document.getElementById('reportsContainer').innerHTML = 
                    '<p style="color: #ff3b30; background: #fff5f5; padding: 15px; border-radius: 10px; border: 1px solid #ffcccc;">Error loading reports: ' + error.message + '</p>';
                return;
            }

            // Store data for export
            currentReportsData = data || [];

            // Calculate summary statistics
            let totalSales = 0;
            let totalPatients = 0;
            let reportCount = data.length;

            data.forEach(report => {
                totalSales += report.total_sales;
                totalPatients += report.patient_count;
            });

            const avgPerPatient = totalPatients > 0 ? (totalSales / totalPatients) : 0;

            // Display summary
            const summaryHtml = `
                <div style="background: #f5f5f7; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="color: #86868b; font-size: 13px; margin-bottom: 5px;">Reports Found</div>
                    <div style="color: #1d1d1f; font-size: 24px; font-weight: 600;">${reportCount}</div>
                </div>
                <div style="background: #f5f5f7; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="color: #86868b; font-size: 13px; margin-bottom: 5px;">Total Sales</div>
                    <div style="color: #0066CC; font-size: 24px; font-weight: 600;">$${totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div style="background: #f5f5f7; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="color: #86868b; font-size: 13px; margin-bottom: 5px;">Total Patients</div>
                    <div style="color: #1d1d1f; font-size: 24px; font-weight: 600;">${totalPatients.toLocaleString()}</div>
                </div>
                <div style="background: #f5f5f7; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="color: #86868b; font-size: 13px; margin-bottom: 5px;">Avg per Patient</div>
                    <div style="color: #0066CC; font-size: 24px; font-weight: 600;">$${avgPerPatient.toFixed(2)}</div>
                </div>
            `;
            document.getElementById('reportsSummary').innerHTML = summaryHtml;

            if (data.length === 0) {
                document.getElementById('reportsContainer').innerHTML = 
                    '<p style="color: #86868b; text-align: center; padding: 40px;">No sales reports found for the selected filters.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Date</th><th>Clinic</th><th>Sales</th><th>Patients</th><th>Avg/Patient</th><th>Submitted By</th></tr></thead><tbody>';
            
            data.forEach(report => {
                const avgPerPatient = (report.total_sales / report.patient_count).toFixed(2);
                html += `
                    <tr>
                        <td>${new Date(report.date).toLocaleDateString()}</td>
                        <td>${report.clinic}</td>
                        <td>$${report.total_sales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${report.patient_count}</td>
                        <td>$${avgPerPatient}</td>
                        <td>${report.user_profiles.name}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('reportsContainer').innerHTML = html;
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        
        function getExportFilename(extension) {
            const filterClinic = document.getElementById('filterClinic').value;
            const rangeType = document.getElementById('filterDateRange').value;
            const timestamp = new Date().toISOString().split('T')[0];
            
            let filename = 'Sales_Report';
            if (filterClinic !== 'all') {
                filename += '_' + filterClinic.replace(/\s+/g, '_');
            }
            if (rangeType !== 'all') {
                filename += '_' + rangeType;
            }
            filename += '_' + timestamp + '.' + extension;
            
            return filename;
        }

        function exportToExcel() {
            if (currentReportsData.length === 0) {
                alert('No data to export. Please load some reports first.');
                return;
            }

            // Prepare data for Excel
            const excelData = currentReportsData.map(report => ({
                'Date': new Date(report.date).toLocaleDateString(),
                'Clinic': report.clinic,
                'Total Sales': parseFloat(report.total_sales),
                'Patient Count': report.patient_count,
                'Avg per Patient': parseFloat((report.total_sales / report.patient_count).toFixed(2)),
                'Submitted By': report.user_profiles.name,
                'Notes': report.notes || ''
            }));

            // Calculate totals
            const totalSales = currentReportsData.reduce((sum, r) => sum + r.total_sales, 0);
            const totalPatients = currentReportsData.reduce((sum, r) => sum + r.patient_count, 0);
            const avgPerPatient = totalPatients > 0 ? (totalSales / totalPatients) : 0;

            // Add summary row
            excelData.push({});
            excelData.push({
                'Date': 'TOTALS',
                'Clinic': '',
                'Total Sales': totalSales,
                'Patient Count': totalPatients,
                'Avg per Patient': parseFloat(avgPerPatient.toFixed(2)),
                'Submitted By': '',
                'Notes': ''
            });

            // Create workbook
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Set column widths
            ws['!cols'] = [
                {wch: 12},  // Date
                {wch: 20},  // Clinic
                {wch: 15},  // Total Sales
                {wch: 15},  // Patient Count
                {wch: 15},  // Avg per Patient
                {wch: 20},  // Submitted By
                {wch: 30}   // Notes
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sales Reports');

            // Generate file
            XLSX.writeFile(wb, getExportFilename('xlsx'));
        }

        function exportToPDF() {
            if (currentReportsData.length === 0) {
                alert('No data to export. Please load some reports first.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // Add title
            doc.setFontSize(18);
            doc.setTextColor(0, 102, 204);
            doc.text('Clinic Sales Report', 14, 20);

            // Add filter info
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const filterClinic = document.getElementById('filterClinic').value;
            const rangeType = document.getElementById('filterDateRange').value;
            let filterText = 'Filters: ';
            if (filterClinic !== 'all') {
                filterText += 'Clinic: ' + filterClinic + ' | ';
            }
            filterText += 'Period: ' + rangeType;
            filterText += ' | Generated: ' + new Date().toLocaleDateString();
            doc.text(filterText, 14, 28);

            // Prepare table data
            const tableData = currentReportsData.map(report => [
                new Date(report.date).toLocaleDateString(),
                report.clinic,
                '$' + report.total_sales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                report.patient_count.toString(),
                '$' + (report.total_sales / report.patient_count).toFixed(2),
                report.user_profiles.name
            ]);

            // Calculate totals
            const totalSales = currentReportsData.reduce((sum, r) => sum + r.total_sales, 0);
            const totalPatients = currentReportsData.reduce((sum, r) => sum + r.patient_count, 0);
            const avgPerPatient = totalPatients > 0 ? (totalSales / totalPatients) : 0;

            // Add totals row
            tableData.push([
                'TOTALS',
                '',
                '$' + totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}),
                totalPatients.toString(),
                '$' + avgPerPatient.toFixed(2),
                ''
            ]);

            // Generate table
            doc.autoTable({
                head: [['Date', 'Clinic', 'Sales', 'Patients', 'Avg/Patient', 'Submitted By']],
                body: tableData,
                startY: 35,
                theme: 'striped',
                headStyles: {
                    fillColor: [0, 102, 204],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 9,
                    cellPadding: 5
                },
                columnStyles: {
                    2: { halign: 'right' },  // Sales
                    3: { halign: 'right' },  // Patients
                    4: { halign: 'right' }   // Avg/Patient
                },
                didParseCell: function(data) {
                    // Style the totals row
                    if (data.row.index === tableData.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [245, 245, 247];
                    }
                }
            });

            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            doc.setFontSize(8);
            doc.setTextColor(150);
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.text(
                    'Clinic Sales Reporting System - Page ' + i + ' of ' + pageCount,
                    doc.internal.pageSize.width / 2,
                    doc.internal.pageSize.height - 10,
                    { align: 'center' }
                );
            }

            // Save PDF
            doc.save(getExportFilename('pdf'));
        }

        // ============================================
        // ANALYTICS
        // ============================================
        
        async function loadAnalytics() {
            const rangeType = document.getElementById('analyticsDateRange').value;
            
            let query = supabase
                .from('sales_reports')
                .select('*');

            // Apply date filtering
            if (rangeType !== 'all') {
                const dateRange = getDateRange(rangeType);
                if (dateRange) {
                    query = query.gte('date', dateRange.start).lte('date', dateRange.end);
                }
            }

            const { data, error } = await query;

            if (error || !data) return;

            // Calculate totals
            let totalSales = 0;
            let totalPatients = 0;
            const clinicData = {};

            data.forEach(report => {
                totalSales += report.total_sales;
                totalPatients += report.patient_count;

                if (!clinicData[report.clinic]) {
                    clinicData[report.clinic] = {
                        sales: 0,
                        patients: 0
                    };
                }
                clinicData[report.clinic].sales += report.total_sales;
                clinicData[report.clinic].patients += report.patient_count;
            });

            // Update stats
            document.getElementById('totalSalesAll').textContent = '$' + totalSales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalPatients').textContent = totalPatients.toLocaleString();
            document.getElementById('avgPerPatient').textContent = 
                totalPatients > 0 ? '$' + (totalSales / totalPatients).toFixed(2) : '$0';

            // Update clinic breakdown
            let breakdownHtml = '';
            for (const clinic in clinicData) {
                const avgPerPatient = (clinicData[clinic].sales / clinicData[clinic].patients).toFixed(2);
                breakdownHtml += `
                    <div class="sales-card">
                        <h3>${clinic}</h3>
                        <div class="amount">$${clinicData[clinic].sales.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="date">${clinicData[clinic].patients} patients | $${avgPerPatient} avg</div>
                    </div>
                `;
            }
            document.getElementById('clinicBreakdown').innerHTML = breakdownHtml;
        }

        // ============================================
        // UI HELPERS
        // ============================================
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load data if needed
            if (tabName === 'view') {
                loadReports();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        // Initialize on page load
        checkAuth();
    </script>
</body>
</html>

